---
## Gitleaks Secrets Detection

name: 01 - Secrets Scan

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1' # Weekly scan

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write # Required for PR comments

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download and install Gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          tar -xzf gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          chmod +x gitleaks
          ./gitleaks version

      - name: Scan for secrets (JSON)
        id: gitleaks-json
        run: |
          ./gitleaks detect \
            --source=. \
            --config=.gitleaks.toml \
            --report-format=json \
            --report-path=results.json \
            --redact \
            --verbose \
            --exit-code=0

          # Count findings
          if [ -f results.json ]; then
            FINDINGS=$(jq '. | length' results.json 2>/dev/null || echo "0")
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
            echo "Found $FINDINGS potential secret(s)"

            if [ "$FINDINGS" -gt 0 ]; then
              echo "has_findings=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "has_findings=false" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true

      - name: Scan for secrets (SARIF)
        if: always()
        run: |
          ./gitleaks detect \
            --source=. \
            --config=.gitleaks.toml \
            --report-format=sarif \
            --report-path=results.sarif \
            --redact \
            --verbose \
            --exit-code=0

      - name: Verify SARIF file
        if: always()
        run: |
          if [ -f results.sarif ]; then
            echo "âœ… SARIF file generated successfully"
            ls -lh results.sarif
            FILE_SIZE=$(stat -c%s results.sarif 2>/dev/null || stat -f%z results.sarif 2>/dev/null || echo "0")
            echo "File size: $FILE_SIZE bytes"
          else
            echo "âš ï¸ SARIF file not found"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-reports-${{ github.sha }}
          path: |
            results.json
            results.sarif
          retention-days: 90
          if-no-files-found: warn

      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: gitleaks
          wait-for-processing: true
        continue-on-error: true

      - name: Comment on PR with findings
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          steps.gitleaks-json.outputs.has_findings == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let findings = 0;
            let details = [];

            try {
              if (fs.existsSync('results.json')) {
                const report = JSON.parse(fs.readFileSync('results.json', 'utf8'));
                findings = report.length || 0;

                // Extract first few findings for summary (limit to 3)
                details = report.slice(0, 3).map(finding => {
                  return `- **${finding.RuleID || 'Unknown'}**: \`${finding.File || 'Unknown file'}\` (Line ${finding.StartLine || '?'})`;
                });

                if (report.length > 3) {
                  details.push(`- ... and ${report.length - 3} more finding(s)`);
                }
              }
            } catch (e) {
              console.log('Could not read report:', e);
              findings = '${{ steps.gitleaks-json.outputs.findings }}' || 0;
            }

            const comment = `## ğŸ” Secret Scan Results

            âš ï¸ **${findings} potential secret(s) detected**

            ### Summary of Findings:
            ${details.length > 0 ? details.join('\n') : '_See artifacts for details_'}

            ### Required Actions:
            1. ğŸ” **Review**: Download the [full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) from workflow artifacts
            2. ğŸ—‘ï¸ **Remove**: Delete any actual secrets from your code
            3. ğŸ”„ **Rotate**: Immediately rotate any exposed credentials
            4. ğŸ”‘ **Replace**: Use GitHub Secrets, GCP Secret Manager, or Kubernetes Secrets instead
            5. âœ… **Update**: Add false positives to \`.gitleaks.toml\` allowlist if needed

            ### Next Steps:
            - Do **NOT** merge this PR until all secrets are resolved
            - If credentials were committed, they must be rotated even if removed from code
            - Need help? Check the [Security Runbook](../docs/security.md)

            ---
            <sub>ğŸ¤– Automated security scan by Gitleaks | [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR - Clean scan
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          steps.gitleaks-json.outputs.has_findings == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… Secret Scan Results

            **No secrets detected** - Your code is clean!

            All security checks passed. Safe to merge.

            ---
            <sub>ğŸ¤– Automated security scan by Gitleaks | [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail job if secrets found
        if: steps.gitleaks-json.outputs.has_findings == 'true'
        run: |
          echo "::error::Secrets detected in the code. Please review and remove them."
          exit 1
