---
# Pre-commit hooks configuration for SecureML Platform GitOps Pipeline
# See https://pre-commit.com for more information

repos:
  # ============================================
  # SECURITY CHECKS (Highest Priority)
  # ============================================

  # Gitleaks - Secrets detection
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks
        name: Detect hardcoded secrets
        description: Scan for secrets, passwords, and credentials
        args: ['--verbose', '--config', '.gitleaks.toml']

  # ============================================
  # SEMGREP - SAST
  # ============================================
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.89.0
    hooks:
      - id: semgrep
        name: Semgrep SAST Scanner
        description: Static analysis for security vulnerabilities and secrets (security-audit + secrets rulesets)
        args: ['--config=p/security-audit', '--config=p/secrets', '--error']

  # ============================================
  # AUTO-FORMATTING (Run before linters)
  # ============================================

  # Prettier - Universal formatter for YAML, Markdown, JSON, etc.
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: Format with Prettier
        description: Auto-format YAML, Markdown, JSON, and more
        types_or: [yaml, markdown, json, javascript, css, html]
        args: ['--write', '--print-width=120']

  # ============================================
  # BASIC FILE CHECKS
  # ============================================

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # File cleanup (auto-fix)
      - id: trailing-whitespace
        name: Trim trailing whitespace
        args: [--markdown-linebreak-ext=md]

      - id: end-of-file-fixer
        name: Fix end of files

      - id: mixed-line-ending
        name: Fix mixed line endings
        args: ['--fix=lf']

      # Syntax validation (no auto-fix)
      - id: check-yaml
        name: Check YAML syntax
        description: Validate YAML files are parseable
        args: ['--unsafe'] # Allow custom tags for GitHub Actions

      - id: check-json
        name: Check JSON syntax
        description: Validate JSON files are parseable

      - id: check-toml
        name: Check TOML syntax
        description: Validate TOML files are parseable

      # Security checks
      - id: detect-private-key
        name: Detect private keys
        description: Prevent committing private keys
        exclude: '^\.gitleaks\.toml$' # Exclude gitleaks config (contains key patterns)

      - id: check-added-large-files
        name: Check for large files
        description: Prevent large files (>1MB) from being committed
        args: ['--maxkb=1000']

      # Merge and conflict checks
      - id: check-merge-conflict
        name: Check for merge conflicts
        description: Detect merge conflict markers

      - id: check-case-conflict
        name: Check for case conflicts
        description: Detect case-insensitive filename conflicts

      # Script checks
      - id: check-executables-have-shebangs
        name: Check shebangs
        description: Ensure executable scripts have shebangs

      - id: check-shebang-scripts-are-executable
        name: Check executable scripts
        description: Ensure scripts with shebangs are executable

  # ============================================
  # YAML VALIDATION (After Prettier formatting)
  # ============================================

  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: Lint YAML files
        description: Validate YAML best practices and catch errors
        args:
          - '-d'
          - |
            {
              extends: relaxed,
              rules: {
                line-length: {max: 200, level: warning},
                indentation: {spaces: 2},
                brackets: {max-spaces-inside: 1},
                comments: {min-spaces-from-content: 1},
                document-start: disable,
                truthy: {
                  allowed-values: ['true', 'false', 'yes', 'no', 'on', 'off'],
                  check-keys: false
                }
              }
            }

  # ============================================
  # PYTHON FORMATTING & LINTING
  # ============================================

  # Black - Python code formatter
  - repo: https://github.com/psf/black
    rev: 25.12.0
    hooks:
      - id: black
        name: Format Python with Black
        description: Auto-format Python code
        language_version: python3.11
        args: ['--line-length=100']

  # isort - Python import sorter
  - repo: https://github.com/pycqa/isort
    rev: 7.0.0
    hooks:
      - id: isort
        name: Sort Python imports
        description: Auto-sort Python imports
        args: ['--profile', 'black', '--line-length=100']

  # Flake8 - Python linter (optional but recommended)
  - repo: https://github.com/pycqa/flake8
    rev: 7.3.0
    hooks:
      - id: flake8
        name: Lint Python with Flake8
        description: Check Python code quality
        args: ['--max-line-length=100', '--extend-ignore=E203,W503']

  # ============================================
  # SHELL SCRIPT VALIDATION
  # ============================================

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        name: Check shell scripts
        description: Lint shell scripts with ShellCheck
        args: ['-x'] # Follow source statements

  # ============================================
  # DOCKERFILE VALIDATION
  # ============================================

  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker
        name: Lint Dockerfiles
        description: Best practices for Dockerfiles

  # ============================================
  # TERRAFORM VALIDATION (if using Terraform)
  # ============================================

  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.105.0
    hooks:
      - id: terraform_fmt
        name: Format Terraform
      - id: terraform_validate
        name: Validate Terraform
      - id: terraform_tflint
        name: Lint Terraform

  # ============================================
  # KUBERNETES YAML VALIDATION (Optional)
  # ============================================

  - repo: https://github.com/google/go-jsonnet
    rev: v0.21.0
    hooks:
      - id: jsonnet-format
        name: Format Jsonnet

# ============================================
# GLOBAL PRE-COMMIT CONFIGURATION
# ============================================

# Fail fast - stop on first failure
fail_fast: false

# Minimum pre-commit version
minimum_pre_commit_version: '3.0.0'

# Default language version
default_language_version:
  python: python3.11
  node: system

# Default stages
# default_stages: [pre-commit, pre-push]
default_stages: [pre-commit]
